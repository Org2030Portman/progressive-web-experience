before_script:
  # - ng --version
  - yarn --version
  - date

after_script:
  - date

stages:
  - restore
  - build
  - test
  - package
  - publish
  - deploy

restore:
  stage: restore
  only:
    - /^.*\/feature\/.*$/
    - /^.*\/bugfix\/.*$/
    - master
    - develop
    - /^.*\/release\/.*$/
  script:
    - cd workspace
    - fdescribes=""
    - fdescribes=$(grep -R --include \*.spec* --exclude-dir=node_modules -w "fdescribe('*" ./ || true)
    - if [[ $fdescribes ]]; then echo "Found fdescribes!" && echo $fdescribes && exit 1; else echo "No fdscribes found"; fi;
    - fits=""
    - fits=$(grep -R --include \*.spec* --exclude-dir=node_modules -w "fit('*" ./ || true)
    - if [[ $fits ]]; then echo "Found fits!" && echo $fits && exit 1; else echo "No fits found"; fi;
    - yarn install
  cache:
    key: nodemodules
    paths:
      - workspace/node_modules

build:snapshot:
  stage: build
  # only build non prod branches
  only:
    - /^.*\/feature\/.*$/
    - /^.*\/bugfix\/.*$/
  except:
    - master
    - /^.*\/release\/.*$/
  script:
    - cd workspace
    - ng build lms --aot --no-progress
    - rm -rf dist
    - ng build lms --no-progress
  artifacts:
    expire_in: 1 day
    paths:
      - workspace/dist
  cache:
    key: nodemodules
    policy: pull
    paths:
      - workspace/node_modules

build:rc:
  stage: build
  # only build non prod branches
  only:
    - develop
    - /^.*\/release\/.*$/
  script:
    - cd workspace
    - ng build lms --aot --no-progress
  artifacts:
    expire_in: 1 day
    paths:
      - workspace/dist
  cache:
    key: nodemodules
    policy: pull
    paths:
      - workspace/node_modules

build:release:
  stage: build
  # only build master and release branches
  only:
    - master
  script:
    - cd workspace
    - ng build lms --aot --prod --no-progress
  artifacts:
    expire_in: 1 day
    paths:
      - workspace/dist
  cache:
    key: nodemodules
    policy: pull
    paths:
      - workspace/node_modules

test:lint:
  stage: test
  only:
    - /^.*\/feature\/.*$/
    - /^.*\/bugfix\/.*$/
    - master
    - develop
    - /^.*\/release\/.*$/
  script:
    - cd workspace
    - yarn lint
  cache:
    key: nodemodules
    policy: pull
    paths:
      - workspace/node_modules

test:lintformatting:
  stage: test
  only:
    - /^.*\/feature\/.*$/
    - /^.*\/bugfix\/.*$/
    - master
    - develop
    - /^.*\/release\/.*$/
  script:
    - cd workspace
    - yarn format:check
  cache:
    key: nodemodules
    policy: pull
    paths:
      - workspace/node_modules

test:unit:
  stage: test
  only:
    - /^.*\/feature\/.*$/
    - /^.*\/bugfix\/.*$/
    - master
    - develop
    - /^.*\/release\/.*$/
  script:
    - cd workspace;
    - rm karma.conf.js;
    - mv karma.conf.js.build karma.conf.js;
    - yarn test;
  cache:
    key: nodemodules
    policy: pull
    paths:
      - workspace/node_modules

package:snapshot:
  stage: package
  only:
    - /^.*\/feature\/.*$/
    - /^.*\/bugfix\/.*$/
    - /^.*\/release\/.*$/
    - develop
  except:
    - master
  script:
    - cd workspace
    - echo "Package here"
    - cleanver=$(cat package.json | jq '.version' | cut -d '"' -f 2)
    - packageVer="$cleanver-$CI_COMMIT_REF_NAME-$CI_BUILD_ID"
    - cleanPackageVer=$(echo $packageVer | tr / _)
    - echo $cleanPackageVer
    - echo "PACKAGE_VERSION=$cleanPackageVer"    > env.props
    - echo "PROJECT_NAME=lms"           >> env.props
    - cat env.props
    - mv dist/apps/lms/* dist/
    - rm -rf dist/apps/
    - zip -r lms.$cleanPackageVer.zip dist/
    - ls lms.*.zip
    - mv lms.*.zip ../
  cache:
    key: packagevars
    paths:
      - workspace/env.props
  artifacts:
    expire_in: 1 day
    paths:
      - lms.*.zip
      - workspace/env.props
  dependencies:
    - build:snapshot
    - build:rc

package:release:
  stage: package
  only:
    - master
  script:
    - cd workspace
    - echo "Package here"
    - cleanver=$(cat package.json | jq '.version' | cut -d '"' -f 2)
    - echo $cleanver
    - echo "PACKAGE_VERSION=$cleanver"    > env.props
    - echo "PROJECT_NAME=lms"    >> env.props
    - cat env.props
    - mv dist/apps/lms/* dist/
    - rm -rf dist/apps/
    - zip -r lms.$cleanver.zip dist/
    - ls lms.*.zip
    - mv lms.*.zip ../
  cache:
    key: packagevars
    paths:
      - workspace/env.props
  artifacts:
    expire_in: 1 day
    paths:
      - lms.*.zip
      - workspace/env.props
  dependencies:
    - build:release

publish:
  stage: publish
  only:
    - /^.*\/feature\/.*$/
    - /^.*\/bugfix\/.*$/
    - master
    - develop
    - /^.*\/release\/.*$/
  script:
    - pkg=$(ls lms.*.zip)
    - echo $pkg
    - curl -v -k --upload-file $pkg https://pacman.tcdevops.com/repository/Angular/$pkg

deploy:test:
  stage: deploy
  only:
    - /^.*\/feature\/.*$/
    - /^.*\/bugfix\/.*$/
  except:
    - master
    - /^.*\/release\/.*$/
  script:
    - appVars=$(find . -type f \( -iname "env.props" \));
    - source $appVars;
    - echo $PROJECT_NAME;
    - echo $PACKAGE_VERSION;
    - git clone http://gitlab.tcdevops.com/ansible/Deploy.AngularApp.git
    - url="https://serverinventory.tcdevops.com/ansible_inventory?Tags=$PROJECT_NAME&Tags=TestEnv&Tags=linux";
      curl -v -X GET --header "Accept:text/plain" $url      > inventory;
      echo "[target_servers:vars]"                          >> inventory;
      echo "ansible_user=ansible_rm"                        >> inventory;
      echo "ansible_connection=ssh"                         >> inventory;
      export ANSIBLE_FORCE_COLOR=true;
      ansible-playbook ./Deploy.AngularApp/deploy_angular_app_svc_registration.yml -i inventory --extra-vars "TARGET_MACHINE=target_servers ANGULAR_APP_NAME=$PROJECT_NAME ANGULAR_APP_VERSION=$PACKAGE_VERSION URL_PREFIX=testnextgen.dropcatch.com/";
  cache:
    key: packagevars
    policy: pull
    paths:
      - workspace/env.props
  when: manual

deploy:stage:
  stage: deploy
  only:
    - /^.*\/release\/.*$/
    - develop
  script:
    - appVars=$(find . -type f \( -iname "env.props" \));
    - source $appVars;
    - echo $PROJECT_NAME;
    - echo $PACKAGE_VERSION;
    - git clone http://gitlab.tcdevops.com/ansible/Deploy.AngularApp.git
    - url="https://serverinventory.tcdevops.com/ansible_inventory?Tags=$PROJECT_NAME&Tags=Staging&Tags=linux";
      curl -v -X GET --header "Accept:text/plain" $url      > inventory;
      echo "[target_servers:vars]"                          >> inventory;
      echo "ansible_user=ansible_rm"                        >> inventory;
      echo "ansible_connection=ssh"                         >> inventory;
      export ANSIBLE_FORCE_COLOR=true;
      ansible-playbook ./Deploy.AngularApp/deploy_angular_app_svc_registration.yml -i inventory --extra-vars "TARGET_MACHINE=target_servers ANGULAR_APP_NAME=$PROJECT_NAME ANGULAR_APP_VERSION=$PACKAGE_VERSION URL_PREFIX=stgnextgen.dropcatch.com/";
  cache:
    key: packagevars
    policy: pull
    paths:
      - workspace/env.props
  when: manual

deploy:production:
  stage: deploy
  only:
    - master
  script:
    - appVars=$(find . -type f \( -iname "env.props" \));
    - source $appVars;
    - echo $PROJECT_NAME;
    - echo $PACKAGE_VERSION;
    - git clone http://gitlab.tcdevops.com/ansible/Deploy.AngularApp.git
    - url="https://serverinventory.tcdevops.com/ansible_inventory?Tags=$PROJECT_NAME&Tags=Production&Tags=linux";
      curl -v -X GET --header "Accept:text/plain" $url      > inventory;
      echo "[target_servers:vars]"                          >> inventory;
      echo "ansible_user=ansible_rm"                        >> inventory;
      echo "ansible_connection=ssh"                         >> inventory;
      export ANSIBLE_FORCE_COLOR=true;
      ansible-playbook ./Deploy.AngularApp/deploy_angular_app_svc_registration.yml -i inventory --extra-vars "TARGET_MACHINE=target_servers ANGULAR_APP_NAME=$PROJECT_NAME ANGULAR_APP_VERSION=$PACKAGE_VERSION URL_PREFIX=nextgen.dropcatch.com/";
  cache:
    key: packagevars
    policy: pull
    paths:
      - workspace/env.props
  when: manual
